{% extends 'base.htm' %}
{% load static %}
{% block body %}
<style>
/*** Floating button styling ***/
.float{
    position:fixed;
    width:60px;
    height:60px;
    bottom:40px;
    background-color:#0275d8;
    color:#FFF;
    border-radius:50px;
    text-align:center;
    box-shadow: 2px 2px 3px #999;
}
.float-icon{
    margin-top:14px;
}
.float.right{
    right:40px;
}
.float.left{
    left:40px;
}

/*******************************
* MODAL AS LEFT/RIGHT SIDEBAR
* Add "left" or "right" in modal parent div, after class="modal".
*******************************/
.modal.left .modal-dialog,
.modal.right .modal-dialog {
    position: fixed;
    margin: auto;
    top: 0px;
    height: 100%;
    -webkit-transform: translate3d(0%, 0, 0);
        -ms-transform: translate3d(0%, 0, 0);
         -o-transform: translate3d(0%, 0, 0);
            transform: translate3d(0%, 0, 0);
}

.modal.left .modal-content,
.modal.right .modal-content {
    height: 100%;
    overflow-y: auto;
}

.modal.left .modal-body,
.modal.right .modal-body {
    padding: 15px 15px 80px;
}

/*Left*/
.modal.left.fade .modal-dialog{
    left: 0px;
    -webkit-transition: opacity 0.3s linear, left 0.3s ease-out;
       -moz-transition: opacity 0.3s linear, left 0.3s ease-out;
         -o-transition: opacity 0.3s linear, left 0.3s ease-out;
            transition: opacity 0.3s linear, left 0.3s ease-out;
}

.modal.left.fade.in .modal-dialog{
    left: 0px;
}

/*Right*/
.modal.right.fade .modal-dialog {
    right: 0px;
    -webkit-transition: opacity 0.3s linear, right 0.3s ease-out;
       -moz-transition: opacity 0.3s linear, right 0.3s ease-out;
         -o-transition: opacity 0.3s linear, right 0.3s ease-out;
            transition: opacity 0.3s linear, right 0.3s ease-out;
}

.modal.right.fade.in .modal-dialog {
    right: 0px;
}

/* ----- MODAL STYLE ----- */
.modal-content {
    border-radius: 0;
    border: none;
}

.modal-header {
    display: inline;
    border-bottom-color: #EEEEEE;
    background-color: #FAFAFA;
}
</style>

<!-- Open plot options modal if no plot present --!>
{% if not plot_html %}
<script>
$(window).on('load',function(){
    var delayMs = 250; // delay in milliseconds
    setTimeout(function(){
        $('#plotOptionsModal').modal('show');
    }, delayMs);
});
</script>
{% endif %}

<!-- Clear stubborn select2 widgets when empty to prevent sending empty GET params-->
<script type="text/javascript">
    $(document).ready(function() {
        $("#plot_form").submit(function() {
            if($("#id_metadata_collapse").val()=="") {
                $("#id_metadata_collapse").remove();
            }
        });
     });
</script>

<!-- Plot Options Modal -->
<div class="modal left fade" id="plotOptionsModal" tabindex="-1" role="dialog" aria-labelledby="plotOptionsLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content" style="width:150%;" >
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="plotOptionsLabel">Plot Options</h4>
            </div>
            <div class="modal-body">
            <p><form method="get" id="plot_form">
                    {{ form.as_p }}
                    <button class="btn btn-primary" type="submit" ><i class="fas fa-chart-bar"></i>&nbsp;Plot</button>
                </form></p>
            </div>
        </div>
    </div>
</div>

<!-- Help Modal -->
<div class="modal right fade" id="helpModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">

                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">Plot Help</h4>
                </div>

                <div class="modal-body">
    <p>This plot was generated by the count_table_tax_plot() function in db/plot.py of QUOREM's codebase. It calls on the collapsed_table() function also in db/plot.py. The plotting library used is plotly.</p>

    <p>In collapsed_table(): The count table (as a Matrix Value) is retrieved from the Result and stored in a Pandas DataFrame using the Feature names and Sample names as the indexes. If a metadata value is supplied to collapse by, the counts are summed at this stage. The count table is then normalized with the user-selected method. "Raw", "counts", and "none" all return the counts unchanged. "Proportion" divides each count by the sum in the Sample. "Percent" is proportion multiplied by 100. The taxonomic classifications are retrieved by pulling the 'taxonomic_classification' metadata from the classification Result along with the Feature names. The classifications are cut on semi-colon characters (;) and the user-specified level is taken by mapping the typical Linnean levels KPCOFGS to 1 through 7. If a Feature's 'taxonomic_classification' did not have an N-th level, it is assigned 'Unclassified at level N'. This category can be dynamically hidden by double-clicking its legend entry. If your classifications are not 7-level semi-colon delimited, this function may not behave as expected. The count and taxonomic tables are then merged and returned.</p>
    <p>In count_table_tax_plot(): The collapsed table has empty columns removed, sorts the table by the row (taxa) sums and retains only the user-specified top N taxa. The plot is then generated with plotly.express's bar(), imshow(), area(), box(), or violin() functions.</p>

                </div>
            </div>
        </div>
    </div>

<!-- Plot Container -->
<div class="container-fluid">
    <div class="col col-lg-12 text-center align-self-center">
        {% if plot_html %}
            {{ plot_html|safe }}
        {% else %}
            <br/>
            <h2>Click the <i class="fa fa-cog"></i> button in the bottom-left to open plot options</h2>
        {% endif %}
    </div>
</div>

<!-- Includes for form (i.e., select2 stuff generally) -->
{{ form.media }}

<!-- Floating bottom buttons -->
<a href="#" class="float left" data-toggle="modal" data-target="#plotOptionsModal">
    <i class="fa fa-cog fa-2x float-icon"></i>
</a>

{%if plot_html %}
<a href="#" class="float right" data-toggle="modal" data-target="#helpModal">
    <i class="fa fa-question fa-2x float-icon"></i>
</a>
{% endif %}

{% endblock body %}
